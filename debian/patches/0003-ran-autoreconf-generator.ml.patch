From: Hilko Bengen <bengen@debian.org>
Date: Sat, 19 Nov 2011 22:12:44 +0100
Subject: ran autoreconf, generator.ml

---
 Makefile.in              |    2 +-
 aclocal.m4               |   14 +++--
 config.h.in              |    6 +-
 configure                |  152 +++++++++++++++++++++++++++++++++++++---------
 generator/Makefile.in    |    2 +-
 gnulib/lib/Makefile.in   |    2 +-
 gnulib/tests/Makefile.in |    2 +-
 images/Makefile.in       |    2 +-
 lib/Makefile.in          |    2 +-
 lib/hivex.pod            |    6 +-
 lib/tools/Makefile.in    |    2 +-
 ocaml/Makefile.in        |    2 +-
 perl/Makefile.in         |    2 +-
 perl/lib/Win/Hivex.pm    |    6 +-
 python/Makefile.in       |    4 +-
 python/hivex-py.c        |  101 ++++++++++++++++++++++++-------
 python/hivex.py          |   50 ++++++++--------
 regedit/Makefile.in      |    2 +-
 ruby/Makefile.in         |    2 +-
 ruby/ext/hivex/_hivex.c  |    6 +-
 sh/Makefile.in           |    2 +-
 xml/Makefile.in          |    2 +-
 22 files changed, 259 insertions(+), 112 deletions(-)

diff --git a/Makefile.in b/Makefile.in
index fab8182..3d64ca3 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -747,8 +747,8 @@ PTHREAD_H_DEFINES_STRUCT_TIMESPEC = @PTHREAD_H_DEFINES_STRUCT_TIMESPEC@
 PTRDIFF_T_SUFFIX = @PTRDIFF_T_SUFFIX@
 PYTHON = @PYTHON@
 PYTHON_INCLUDEDIR = @PYTHON_INCLUDEDIR@
+PYTHON_INSTALLDIR = @PYTHON_INSTALLDIR@
 PYTHON_PREFIX = @PYTHON_PREFIX@
-PYTHON_SITE_PACKAGES = @PYTHON_SITE_PACKAGES@
 PYTHON_VERSION = @PYTHON_VERSION@
 RAKE = @RAKE@
 RANLIB = @RANLIB@
diff --git a/aclocal.m4 b/aclocal.m4
index 6f27c7f..6574e00 100644
--- a/aclocal.m4
+++ b/aclocal.m4
@@ -47,7 +47,8 @@ To do so, use the procedure documented by the package, typically `autoreconf'.])
 # ----------------------------------
 AC_DEFUN([PKG_PROG_PKG_CONFIG],
 [m4_pattern_forbid([^_?PKG_[A-Z_]+$])
-m4_pattern_allow([^PKG_CONFIG(_PATH)?$])
+m4_pattern_allow([^PKG_CONFIG(_(PATH|LIBDIR|SYSROOT_DIR|ALLOW_SYSTEM_(CFLAGS|LIBS)))?$])
+m4_pattern_allow([^PKG_CONFIG_(DISABLE_UNINSTALLED|TOP_BUILD_DIR|DEBUG_SPEW)$])
 AC_ARG_VAR([PKG_CONFIG], [path to pkg-config utility])
 AC_ARG_VAR([PKG_CONFIG_PATH], [directories to add to pkg-config's search path])
 AC_ARG_VAR([PKG_CONFIG_LIBDIR], [path overriding pkg-config's built-in search path])
@@ -93,7 +94,8 @@ m4_define([_PKG_CONFIG],
     pkg_cv_[]$1="$$1"
  elif test -n "$PKG_CONFIG"; then
     PKG_CHECK_EXISTS([$3],
-                     [pkg_cv_[]$1=`$PKG_CONFIG --[]$2 "$3" 2>/dev/null`],
+                     [pkg_cv_[]$1=`$PKG_CONFIG --[]$2 "$3" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes ],
 		     [pkg_failed=yes])
  else
     pkg_failed=untried
@@ -141,9 +143,9 @@ if test $pkg_failed = yes; then
    	AC_MSG_RESULT([no])
         _PKG_SHORT_ERRORS_SUPPORTED
         if test $_pkg_short_errors_supported = yes; then
-	        $1[]_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$2" 2>&1`
+	        $1[]_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "$2" 2>&1`
         else 
-	        $1[]_PKG_ERRORS=`$PKG_CONFIG --print-errors "$2" 2>&1`
+	        $1[]_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "$2" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$$1[]_PKG_ERRORS" >&AS_MESSAGE_LOG_FD
@@ -156,7 +158,7 @@ $$1_PKG_ERRORS
 Consider adjusting the PKG_CONFIG_PATH environment variable if you
 installed software in a non-standard prefix.
 
-_PKG_TEXT])
+_PKG_TEXT])[]dnl
         ])
 elif test $pkg_failed = untried; then
      	AC_MSG_RESULT([no])
@@ -167,7 +169,7 @@ path to pkg-config.
 
 _PKG_TEXT
 
-To get pkg-config, see <http://pkg-config.freedesktop.org/>.])
+To get pkg-config, see <http://pkg-config.freedesktop.org/>.])[]dnl
         ])
 else
 	$1[]_CFLAGS=$pkg_cv_[]$1[]_CFLAGS
diff --git a/config.h.in b/config.h.in
index 2b43c03..a134cee 100644
--- a/config.h.in
+++ b/config.h.in
@@ -260,15 +260,15 @@
 /* Define to 1 if you have the `mprotect' function. */
 #undef HAVE_MPROTECT
 
-/* Define to 1 if you have the `open_memstream' function. */
-#undef HAVE_OPEN_MEMSTREAM
-
 /* Define to 1 if you have the <OS.h> header file. */
 #undef HAVE_OS_H
 
 /* Define to 1 if you have the `PyCapsule_New' function. */
 #undef HAVE_PYCAPSULE_NEW
 
+/* Define to 1 if you have the `PyString_AsString' function. */
+#undef HAVE_PYSTRING_ASSTRING
+
 /* Define to 1 if atoll is declared even after undefining macros. */
 #undef HAVE_RAW_DECL_ATOLL
 
diff --git a/configure b/configure
index 60b0885..c0acd5e 100755
--- a/configure
+++ b/configure
@@ -626,7 +626,7 @@ HAVE_RUBY_TRUE
 RAKE
 HAVE_PYTHON_FALSE
 HAVE_PYTHON_TRUE
-PYTHON_SITE_PACKAGES
+PYTHON_INSTALLDIR
 PYTHON_INCLUDEDIR
 PYTHON_VERSION
 PYTHON_PREFIX
@@ -1407,6 +1407,7 @@ enable_nls
 enable_rpath
 with_libiconv_prefix
 with_libintl_prefix
+with_python_installdir
 '
       ac_precious_vars='build_alias
 host_alias
@@ -2068,6 +2069,8 @@ Optional Packages:
   --without-libiconv-prefix     don't search for libiconv in includedir and libdir
   --with-libintl-prefix[=DIR]  search for libintl in DIR/include and DIR/lib
   --without-libintl-prefix     don't search for libintl in includedir and libdir
+  --with-python-installdir
+                          directory to install python modules [default=check]
 
 Some influential environment variables:
   CC          C compiler command
@@ -21859,13 +21862,12 @@ fi
 
 
 
-for ac_func in bindtextdomain open_memstream
+for ac_func in bindtextdomain
 do :
-  as_ac_var=`$as_echo "ac_cv_func_$ac_func" | $as_tr_sh`
-ac_fn_c_check_func "$LINENO" "$ac_func" "$as_ac_var"
-if eval test \"x\$"$as_ac_var"\" = x"yes"; then :
+  ac_fn_c_check_func "$LINENO" "bindtextdomain" "ac_cv_func_bindtextdomain"
+if test "x$ac_cv_func_bindtextdomain" = xyes; then :
   cat >>confdefs.h <<_ACEOF
-#define `$as_echo "HAVE_$ac_func" | $as_tr_cpp` 1
+#define HAVE_BINDTEXTDOMAIN 1
 _ACEOF
 
 fi
@@ -23924,6 +23926,7 @@ $as_echo "#define HAVE_DCGETTEXT 1" >>confdefs.h
 
 
 
+
 if test "x$ac_cv_env_PKG_CONFIG_set" != "xset"; then
 	if test -n "$ac_tool_prefix"; then
   # Extract the first word of "${ac_tool_prefix}pkg-config", so it can be a program name with args.
@@ -24052,6 +24055,7 @@ if test -n "$LIBXML2_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_LIBXML2_CFLAGS=`$PKG_CONFIG --cflags "libxml-2.0" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -24068,6 +24072,7 @@ if test -n "$LIBXML2_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_LIBXML2_LIBS=`$PKG_CONFIG --libs "libxml-2.0" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -24087,9 +24092,9 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        LIBXML2_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "libxml-2.0" 2>&1`
+	        LIBXML2_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "libxml-2.0" 2>&1`
         else
-	        LIBXML2_PKG_ERRORS=`$PKG_CONFIG --print-errors "libxml-2.0" 2>&1`
+	        LIBXML2_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "libxml-2.0" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$LIBXML2_PKG_ERRORS" >&5
@@ -24104,7 +24109,6 @@ installed software in a non-standard prefix.
 Alternatively, you may set the environment variables LIBXML2_CFLAGS
 and LIBXML2_LIBS to avoid the need to call pkg-config.
 See the pkg-config man page for more details." "$LINENO" 5
-
 elif test $pkg_failed = untried; then
      	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
@@ -24120,7 +24124,6 @@ See the pkg-config man page for more details.
 
 To get pkg-config, see <http://pkg-config.freedesktop.org/>.
 See \`config.log' for more details" "$LINENO" 5; }
-
 else
 	LIBXML2_CFLAGS=$pkg_cv_LIBXML2_CFLAGS
 	LIBXML2_LIBS=$pkg_cv_LIBXML2_LIBS
@@ -24131,7 +24134,12 @@ fi
 
 
 
- if test "x$HAVE_OPEN_MEMSTREAM" = "xyes"; then
+ac_fn_c_check_func "$LINENO" "open_memstream" "ac_cv_func_open_memstream"
+if test "x$ac_cv_func_open_memstream" = xyes; then :
+
+fi
+
+ if test "x$ac_cv_func_open_memstream" = "xyes"; then
   HAVE_HIVEXSH_TRUE=
   HAVE_HIVEXSH_FALSE='#'
 else
@@ -25259,6 +25267,11 @@ else
 fi
 
 
+PYTHON_PREFIX=
+PYTHON_VERSION=
+PYTHON_INCLUDEDIR=
+PYTHON_INSTALLDIR=
+
 # Extract the first word of "python", so it can be a program name with args.
 set dummy python; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
@@ -25298,12 +25311,20 @@ fi
 
 
 
-PYTHON_PREFIX=
-PYTHON_VERSION=
-
 if test "x$PYTHON" != "xno"; then
-    PYTHON_PREFIX=`$PYTHON -c "import sys; print(sys.prefix)"`
-    PYTHON_VERSION=`$PYTHON -c "import sys; print(sys.version[0:3])"`
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking Python prefix" >&5
+$as_echo_n "checking Python prefix... " >&6; }
+    PYTHON_PREFIX=`$PYTHON -c "import sys; print (sys.prefix)"`
+    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $PYTHON_PREFIX" >&5
+$as_echo "$PYTHON_PREFIX" >&6; }
+
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking Python version" >&5
+$as_echo_n "checking Python version... " >&6; }
+    PYTHON_VERSION_MAJOR=`$PYTHON -c "import sys; print (sys.version_info[0])"`
+    PYTHON_VERSION_MINOR=`$PYTHON -c "import sys; print (sys.version_info[1])"`
+    PYTHON_VERSION="$PYTHON_VERSION_MAJOR.$PYTHON_VERSION_MINOR"
+    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $PYTHON_VERSION" >&5
+$as_echo "$PYTHON_VERSION" >&6; }
 
     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for Python include path" >&5
 $as_echo_n "checking for Python include path... " >&6; }
@@ -25315,23 +25336,96 @@ $as_echo_n "checking for Python include path... " >&6; }
     { $as_echo "$as_me:${as_lineno-$LINENO}: result: $PYTHON_INCLUDEDIR" >&5
 $as_echo "$PYTHON_INCLUDEDIR" >&6; }
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for Python site-packages path" >&5
+
+# Check whether --with-python-installdir was given.
+if test "${with_python_installdir+set}" = set; then :
+  withval=$with_python_installdir; PYTHON_INSTALLDIR="$withval"
+		{ $as_echo "$as_me:${as_lineno-$LINENO}: Python install dir $PYTHON_INSTALLDIR" >&5
+$as_echo "$as_me: Python install dir $PYTHON_INSTALLDIR" >&6;}
+else
+  PYTHON_INSTALLDIR=check
+fi
+
+
+    if test "x$PYTHON_INSTALLDIR" = "xcheck"; then
+        PYTHON_INSTALLDIR=
+        { $as_echo "$as_me:${as_lineno-$LINENO}: checking for Python site-packages path" >&5
 $as_echo_n "checking for Python site-packages path... " >&6; }
-    if test -z "$PYTHON_SITE_PACKAGES"; then
-        PYTHON_SITE_PACKAGES=`$PYTHON -c "import distutils.sysconfig; \
-                print (distutils.sysconfig.get_python_lib(1,0));"`
+        if test -z "$PYTHON_INSTALLDIR"; then
+            PYTHON_INSTALLDIR=`$PYTHON -c "import distutils.sysconfig; \
+                                           print (distutils.sysconfig.get_python_lib(1,0));"`
+        fi
+        { $as_echo "$as_me:${as_lineno-$LINENO}: result: $PYTHON_INSTALLDIR" >&5
+$as_echo "$PYTHON_INSTALLDIR" >&6; }
     fi
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $PYTHON_SITE_PACKAGES" >&5
-$as_echo "$PYTHON_SITE_PACKAGES" >&6; }
 
-    old_LIBS="$LIBS"
-    LIBS="$LIBS -lpython$PYTHON_VERSION"
-    for ac_func in PyCapsule_New
+        old_LIBS="$LIBS"
+    if test "x$PYTHON_VERSION_MAJOR" = "x3"; then
+                LIBPYTHON="python${PYTHON_VERSION}mu"
+    else
+        LIBPYTHON="python$PYTHON_VERSION"
+    fi
+    as_ac_Lib=`$as_echo "ac_cv_lib_$LIBPYTHON''_PyList_Size" | $as_tr_sh`
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for PyList_Size in -l$LIBPYTHON" >&5
+$as_echo_n "checking for PyList_Size in -l$LIBPYTHON... " >&6; }
+if eval \${$as_ac_Lib+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  ac_check_lib_save_LIBS=$LIBS
+LIBS="-l$LIBPYTHON  $LIBS"
+cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
+#ifdef __cplusplus
+extern "C"
+#endif
+char PyList_Size ();
+int
+main ()
+{
+return PyList_Size ();
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_link "$LINENO"; then :
+  eval "$as_ac_Lib=yes"
+else
+  eval "$as_ac_Lib=no"
+fi
+rm -f core conftest.err conftest.$ac_objext \
+    conftest$ac_exeext conftest.$ac_ext
+LIBS=$ac_check_lib_save_LIBS
+fi
+eval ac_res=\$$as_ac_Lib
+	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
+$as_echo "$ac_res" >&6; }
+if eval test \"x\$"$as_ac_Lib"\" = x"yes"; then :
+  cat >>confdefs.h <<_ACEOF
+#define `$as_echo "HAVE_LIB$LIBPYTHON" | $as_tr_cpp` 1
+_ACEOF
+
+  LIBS="-l$LIBPYTHON $LIBS"
+
+else
+  { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+as_fn_error $? "$LIBPYTHON is not installed
+See \`config.log' for more details" "$LINENO" 5; }
+fi
+
+
+    for ac_func in PyCapsule_New \
+                    PyString_AsString
 do :
-  ac_fn_c_check_func "$LINENO" "PyCapsule_New" "ac_cv_func_PyCapsule_New"
-if test "x$ac_cv_func_PyCapsule_New" = xyes; then :
+  as_ac_var=`$as_echo "ac_cv_func_$ac_func" | $as_tr_sh`
+ac_fn_c_check_func "$LINENO" "$ac_func" "$as_ac_var"
+if eval test \"x\$"$as_ac_var"\" = x"yes"; then :
   cat >>confdefs.h <<_ACEOF
-#define HAVE_PYCAPSULE_NEW 1
+#define `$as_echo "HAVE_$ac_func" | $as_tr_cpp` 1
 _ACEOF
 
 fi
@@ -25345,7 +25439,7 @@ fi
 
 
 
- if test "x$PYTHON_INCLUDEDIR" != "x" && test "x$PYTHON_SITE_PACKAGES" != "x"; then
+ if test "x$PYTHON" != "xno" && test "x$PYTHON_INCLUDEDIR" != "x" && test "x$PYTHON_INSTALLDIR" != "x"; then
   HAVE_PYTHON_TRUE=
   HAVE_PYTHON_FALSE='#'
 else
diff --git a/generator/Makefile.in b/generator/Makefile.in
index 4eea56a..5b6aaf6 100644
--- a/generator/Makefile.in
+++ b/generator/Makefile.in
@@ -660,8 +660,8 @@ PTHREAD_H_DEFINES_STRUCT_TIMESPEC = @PTHREAD_H_DEFINES_STRUCT_TIMESPEC@
 PTRDIFF_T_SUFFIX = @PTRDIFF_T_SUFFIX@
 PYTHON = @PYTHON@
 PYTHON_INCLUDEDIR = @PYTHON_INCLUDEDIR@
+PYTHON_INSTALLDIR = @PYTHON_INSTALLDIR@
 PYTHON_PREFIX = @PYTHON_PREFIX@
-PYTHON_SITE_PACKAGES = @PYTHON_SITE_PACKAGES@
 PYTHON_VERSION = @PYTHON_VERSION@
 RAKE = @RAKE@
 RANLIB = @RANLIB@
diff --git a/gnulib/lib/Makefile.in b/gnulib/lib/Makefile.in
index 5a477fc..a503147 100644
--- a/gnulib/lib/Makefile.in
+++ b/gnulib/lib/Makefile.in
@@ -732,8 +732,8 @@ PTHREAD_H_DEFINES_STRUCT_TIMESPEC = @PTHREAD_H_DEFINES_STRUCT_TIMESPEC@
 PTRDIFF_T_SUFFIX = @PTRDIFF_T_SUFFIX@
 PYTHON = @PYTHON@
 PYTHON_INCLUDEDIR = @PYTHON_INCLUDEDIR@
+PYTHON_INSTALLDIR = @PYTHON_INSTALLDIR@
 PYTHON_PREFIX = @PYTHON_PREFIX@
-PYTHON_SITE_PACKAGES = @PYTHON_SITE_PACKAGES@
 PYTHON_VERSION = @PYTHON_VERSION@
 RAKE = @RAKE@
 RANLIB = @RANLIB@
diff --git a/gnulib/tests/Makefile.in b/gnulib/tests/Makefile.in
index 133d918..4380f58 100644
--- a/gnulib/tests/Makefile.in
+++ b/gnulib/tests/Makefile.in
@@ -1005,8 +1005,8 @@ PTHREAD_H_DEFINES_STRUCT_TIMESPEC = @PTHREAD_H_DEFINES_STRUCT_TIMESPEC@
 PTRDIFF_T_SUFFIX = @PTRDIFF_T_SUFFIX@
 PYTHON = @PYTHON@
 PYTHON_INCLUDEDIR = @PYTHON_INCLUDEDIR@
+PYTHON_INSTALLDIR = @PYTHON_INSTALLDIR@
 PYTHON_PREFIX = @PYTHON_PREFIX@
-PYTHON_SITE_PACKAGES = @PYTHON_SITE_PACKAGES@
 PYTHON_VERSION = @PYTHON_VERSION@
 RAKE = @RAKE@
 RANLIB = @RANLIB@
diff --git a/images/Makefile.in b/images/Makefile.in
index ea31078..a9a552c 100644
--- a/images/Makefile.in
+++ b/images/Makefile.in
@@ -696,8 +696,8 @@ PTHREAD_H_DEFINES_STRUCT_TIMESPEC = @PTHREAD_H_DEFINES_STRUCT_TIMESPEC@
 PTRDIFF_T_SUFFIX = @PTRDIFF_T_SUFFIX@
 PYTHON = @PYTHON@
 PYTHON_INCLUDEDIR = @PYTHON_INCLUDEDIR@
+PYTHON_INSTALLDIR = @PYTHON_INSTALLDIR@
 PYTHON_PREFIX = @PYTHON_PREFIX@
-PYTHON_SITE_PACKAGES = @PYTHON_SITE_PACKAGES@
 PYTHON_VERSION = @PYTHON_VERSION@
 RAKE = @RAKE@
 RANLIB = @RANLIB@
diff --git a/lib/Makefile.in b/lib/Makefile.in
index 87d3f8e..0ff52f7 100644
--- a/lib/Makefile.in
+++ b/lib/Makefile.in
@@ -774,8 +774,8 @@ PTHREAD_H_DEFINES_STRUCT_TIMESPEC = @PTHREAD_H_DEFINES_STRUCT_TIMESPEC@
 PTRDIFF_T_SUFFIX = @PTRDIFF_T_SUFFIX@
 PYTHON = @PYTHON@
 PYTHON_INCLUDEDIR = @PYTHON_INCLUDEDIR@
+PYTHON_INSTALLDIR = @PYTHON_INSTALLDIR@
 PYTHON_PREFIX = @PYTHON_PREFIX@
-PYTHON_SITE_PACKAGES = @PYTHON_SITE_PACKAGES@
 PYTHON_VERSION = @PYTHON_VERSION@
 RAKE = @RAKE@
 RANLIB = @RANLIB@
diff --git a/lib/hivex.pod b/lib/hivex.pod
index 5004178..b65a7c5 100644
--- a/lib/hivex.pod
+++ b/lib/hivex.pod
@@ -377,8 +377,7 @@ On error this returns -1 and sets errno.
 
  size_t hivex_node_struct_length (hive_h *h, hive_node_h node);
 
-Return the length of the node data structure.  Returns 0
-and sets errno on error.
+Return the length of the node data structure.
 
 Returns a size.
 On error this returns 0 and sets errno.
@@ -387,8 +386,7 @@ On error this returns 0 and sets errno.
 
  size_t hivex_value_struct_length (hive_h *h, hive_value_h val);
 
-Return the length of the value data structure.  Returns 0
-and sets errno on error.
+Return the length of the value data structure.
 
 Returns a size.
 On error this returns 0 and sets errno.
diff --git a/lib/tools/Makefile.in b/lib/tools/Makefile.in
index a6ae6c3..76fe2ab 100644
--- a/lib/tools/Makefile.in
+++ b/lib/tools/Makefile.in
@@ -670,8 +670,8 @@ PTHREAD_H_DEFINES_STRUCT_TIMESPEC = @PTHREAD_H_DEFINES_STRUCT_TIMESPEC@
 PTRDIFF_T_SUFFIX = @PTRDIFF_T_SUFFIX@
 PYTHON = @PYTHON@
 PYTHON_INCLUDEDIR = @PYTHON_INCLUDEDIR@
+PYTHON_INSTALLDIR = @PYTHON_INSTALLDIR@
 PYTHON_PREFIX = @PYTHON_PREFIX@
-PYTHON_SITE_PACKAGES = @PYTHON_SITE_PACKAGES@
 PYTHON_VERSION = @PYTHON_VERSION@
 RAKE = @RAKE@
 RANLIB = @RANLIB@
diff --git a/ocaml/Makefile.in b/ocaml/Makefile.in
index b2b22b9..4e56452 100644
--- a/ocaml/Makefile.in
+++ b/ocaml/Makefile.in
@@ -668,8 +668,8 @@ PTHREAD_H_DEFINES_STRUCT_TIMESPEC = @PTHREAD_H_DEFINES_STRUCT_TIMESPEC@
 PTRDIFF_T_SUFFIX = @PTRDIFF_T_SUFFIX@
 PYTHON = @PYTHON@
 PYTHON_INCLUDEDIR = @PYTHON_INCLUDEDIR@
+PYTHON_INSTALLDIR = @PYTHON_INSTALLDIR@
 PYTHON_PREFIX = @PYTHON_PREFIX@
-PYTHON_SITE_PACKAGES = @PYTHON_SITE_PACKAGES@
 PYTHON_VERSION = @PYTHON_VERSION@
 RAKE = @RAKE@
 RANLIB = @RANLIB@
diff --git a/perl/Makefile.in b/perl/Makefile.in
index 0767a84..8e64796 100644
--- a/perl/Makefile.in
+++ b/perl/Makefile.in
@@ -663,8 +663,8 @@ PTHREAD_H_DEFINES_STRUCT_TIMESPEC = @PTHREAD_H_DEFINES_STRUCT_TIMESPEC@
 PTRDIFF_T_SUFFIX = @PTRDIFF_T_SUFFIX@
 PYTHON = @PYTHON@
 PYTHON_INCLUDEDIR = @PYTHON_INCLUDEDIR@
+PYTHON_INSTALLDIR = @PYTHON_INSTALLDIR@
 PYTHON_PREFIX = @PYTHON_PREFIX@
-PYTHON_SITE_PACKAGES = @PYTHON_SITE_PACKAGES@
 PYTHON_VERSION = @PYTHON_VERSION@
 RAKE = @RAKE@
 RANLIB = @RANLIB@
diff --git a/perl/lib/Win/Hivex.pm b/perl/lib/Win/Hivex.pm
index cc2dc83..669f440 100644
--- a/perl/lib/Win/Hivex.pm
+++ b/perl/lib/Win/Hivex.pm
@@ -238,8 +238,7 @@ you know the type in advance.
 
  $size = $h->node_struct_length ($node)
 
-Return the length of the node data structure.  Returns 0
-and sets errno on error.
+Return the length of the node data structure.
 
 This returns a size.
 
@@ -247,8 +246,7 @@ This returns a size.
 
  $size = $h->value_struct_length ($val)
 
-Return the length of the value data structure.  Returns 0
-and sets errno on error.
+Return the length of the value data structure.
 
 This returns a size.
 
diff --git a/python/Makefile.in b/python/Makefile.in
index e8fe948..0c2e76d 100644
--- a/python/Makefile.in
+++ b/python/Makefile.in
@@ -725,8 +725,8 @@ PTHREAD_H_DEFINES_STRUCT_TIMESPEC = @PTHREAD_H_DEFINES_STRUCT_TIMESPEC@
 PTRDIFF_T_SUFFIX = @PTRDIFF_T_SUFFIX@
 PYTHON = @PYTHON@
 PYTHON_INCLUDEDIR = @PYTHON_INCLUDEDIR@
+PYTHON_INSTALLDIR = @PYTHON_INSTALLDIR@
 PYTHON_PREFIX = @PYTHON_PREFIX@
-PYTHON_SITE_PACKAGES = @PYTHON_SITE_PACKAGES@
 PYTHON_VERSION = @PYTHON_VERSION@
 RAKE = @RAKE@
 RANLIB = @RANLIB@
@@ -932,7 +932,7 @@ EXTRA_DIST = \
 	hivex-py.c \
 	t/*.py
 
-@HAVE_PYTHON_TRUE@pythondir = $(PYTHON_SITE_PACKAGES)
+@HAVE_PYTHON_TRUE@pythondir = $(PYTHON_INSTALLDIR)
 @HAVE_PYTHON_TRUE@python_DATA = hivex.py
 @HAVE_PYTHON_TRUE@python_LTLIBRARIES = libhivexmod.la
 @HAVE_PYTHON_TRUE@libhivexmod_la_SOURCES = hivex-py.c
diff --git a/python/hivex-py.c b/python/hivex-py.c
index f0144e5..fe55376 100644
--- a/python/hivex-py.c
+++ b/python/hivex-py.c
@@ -24,6 +24,8 @@
  * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
  */
 
+#include <config.h>
+
 #define PY_SSIZE_T_CLEAN 1
 #include <Python.h>
 
@@ -77,40 +79,42 @@ static int
 get_value (PyObject *v, hive_set_value *ret)
 {
   PyObject *obj;
+#ifndef HAVE_PYSTRING_ASSTRING
+  PyObject *bytes;
+#endif
 
   obj = PyDict_GetItemString (v, "key");
   if (!obj) {
     PyErr_SetString (PyExc_RuntimeError, "no 'key' element in dictionary");
     return -1;
   }
-  if (!PyString_Check (obj)) {
-    PyErr_SetString (PyExc_RuntimeError, "'key' element is not a string");
-    return -1;
-  }
+#ifdef HAVE_PYSTRING_ASSTRING
   ret->key = PyString_AsString (obj);
+#else
+  bytes = PyUnicode_AsUTF8String (obj);
+  ret->key = PyBytes_AS_STRING (bytes);
+#endif
 
   obj = PyDict_GetItemString (v, "t");
   if (!obj) {
     PyErr_SetString (PyExc_RuntimeError, "no 't' element in dictionary");
     return -1;
   }
-  if (!PyInt_Check (obj)) {
-    PyErr_SetString (PyExc_RuntimeError, "'t' element is not an integer");
-    return -1;
-  }
-  ret->t = PyInt_AsLong (obj);
+  ret->t = PyLong_AsLong (obj);
 
   obj = PyDict_GetItemString (v, "value");
   if (!obj) {
     PyErr_SetString (PyExc_RuntimeError, "no 'value' element in dictionary");
     return -1;
   }
-  if (!PyString_Check (obj)) {
-    PyErr_SetString (PyExc_RuntimeError, "'value' element is not a string");
-    return -1;
-  }
+#ifdef HAVE_PYSTRING_ASSTRING
   ret->value = PyString_AsString (obj);
   ret->len = PyString_Size (obj);
+#else
+  bytes = PyUnicode_AsUTF8String (obj);
+  ret->value = PyBytes_AS_STRING (bytes);
+  ret->len = PyBytes_GET_SIZE (bytes);
+#endif
 
   return 0;
 }
@@ -164,8 +168,13 @@ put_string_list (char * const * const argv)
     ;
 
   list = PyList_New (argc);
-  for (i = 0; i < argc; ++i)
+  for (i = 0; i < argc; ++i) {
+#ifdef HAVE_PYSTRING_ASSTRING
     PyList_SetItem (list, i, PyString_FromString (argv[i]));
+#else
+    PyList_SetItem (list, i, PyUnicode_FromString (argv[i]));
+#endif
+  }
 
   return list;
 }
@@ -201,7 +210,7 @@ static PyObject *
 put_len_type (size_t len, hive_type t)
 {
   PyObject *r = PyTuple_New (2);
-  PyTuple_SetItem (r, 0, PyInt_FromLong ((long) t));
+  PyTuple_SetItem (r, 0, PyLong_FromLong ((long) t));
   PyTuple_SetItem (r, 1, PyLong_FromLongLong ((long) len));
   return r;
 }
@@ -210,8 +219,12 @@ static PyObject *
 put_val_type (char *val, size_t len, hive_type t)
 {
   PyObject *r = PyTuple_New (2);
-  PyTuple_SetItem (r, 0, PyInt_FromLong ((long) t));
+  PyTuple_SetItem (r, 0, PyLong_FromLong ((long) t));
+#ifdef HAVE_PYSTRING_ASSTRING
   PyTuple_SetItem (r, 1, PyString_FromStringAndSize (val, len));
+#else
+  PyTuple_SetItem (r, 1, PyBytes_FromStringAndSize (val, len));
+#endif
   return r;
 }
 
@@ -323,7 +336,11 @@ py_hivex_node_name (PyObject *self, PyObject *args)
     return NULL;
   }
 
+#ifdef HAVE_PYSTRING_ASSTRING
   py_r = PyString_FromString (r);
+#else
+  py_r = PyUnicode_FromString (r);
+#endif
   free (r);  return py_r;
 }
 
@@ -518,7 +535,11 @@ py_hivex_value_key (PyObject *self, PyObject *args)
     return NULL;
   }
 
+#ifdef HAVE_PYSTRING_ASSTRING
   py_r = PyString_FromString (r);
+#else
+  py_r = PyUnicode_FromString (r);
+#endif
   free (r);  return py_r;
 }
 
@@ -638,7 +659,11 @@ py_hivex_value_string (PyObject *self, PyObject *args)
     return NULL;
   }
 
+#ifdef HAVE_PYSTRING_ASSTRING
   py_r = PyString_FromString (r);
+#else
+  py_r = PyUnicode_FromString (r);
+#endif
   free (r);  return py_r;
 }
 
@@ -686,7 +711,7 @@ py_hivex_value_dword (PyObject *self, PyObject *args)
     return NULL;
   }
 
-  py_r = PyInt_FromLong ((long) r);
+  py_r = PyLong_FromLong ((long) r);
   return py_r;
 }
 
@@ -873,12 +898,44 @@ static PyMethodDef methods[] = {
   { NULL, NULL, 0, NULL }
 };
 
+#if PY_MAJOR_VERSION >= 3
+static struct PyModuleDef moduledef = {
+  PyModuleDef_HEAD_INIT,
+  "libhivexmod",       /* m_name */
+  "hivex module",      /* m_doc */
+  -1,                    /* m_size */
+  methods,               /* m_methods */
+  NULL,                  /* m_reload */
+  NULL,                  /* m_traverse */
+  NULL,                  /* m_clear */
+  NULL,                  /* m_free */
+};
+#endif
+
+static PyObject *
+moduleinit (void)
+{
+  PyObject *m;
+
+#if PY_MAJOR_VERSION >= 3
+  m = PyModule_Create (&moduledef);
+#else
+  m = Py_InitModule ((char *) "libhivexmod", methods);
+#endif
+
+  return m; /* m might be NULL if module init failed */
+}
+
+#if PY_MAJOR_VERSION >= 3
+PyMODINIT_FUNC
+PyInit_libhivexmod (void)
+{
+  return moduleinit ();
+}
+#else
 void
 initlibhivexmod (void)
 {
-  static int initialized = 0;
-
-  if (initialized) return;
-  Py_InitModule ((char *) "libhivexmod", methods);
-  initialized = 1;
+  (void) moduleinit ();
 }
+#endif
diff --git a/python/hivex.py b/python/hivex.py
index 51442aa..b31720e 100644
--- a/python/hivex.py
+++ b/python/hivex.py
@@ -23,7 +23,7 @@
 # License along with this library; if not, write to the Free Software
 # Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
 
-u"""Python bindings for hivex
+"""Python bindings for hivex
 
 import hivex
 h = hivex.Hivex (filename)
@@ -54,98 +54,98 @@ class Hivex:
         libhivexmod.close (self._o)
 
     def root (self):
-        u"""return the root node of the hive"""
+        """return the root node of the hive"""
         return libhivexmod.root (self._o)
 
     def last_modified (self):
-        u"""return the modification time from the header of the hive"""
+        """return the modification time from the header of the hive"""
         return libhivexmod.last_modified (self._o)
 
     def node_name (self, node):
-        u"""return the name of the node"""
+        """return the name of the node"""
         return libhivexmod.node_name (self._o, node)
 
     def node_timestamp (self, node):
-        u"""return the modification time of the node"""
+        """return the modification time of the node"""
         return libhivexmod.node_timestamp (self._o, node)
 
     def node_children (self, node):
-        u"""return children of node"""
+        """return children of node"""
         return libhivexmod.node_children (self._o, node)
 
     def node_get_child (self, node, name):
-        u"""return named child of node"""
+        """return named child of node"""
         return libhivexmod.node_get_child (self._o, node, name)
 
     def node_parent (self, node):
-        u"""return the parent of node"""
+        """return the parent of node"""
         return libhivexmod.node_parent (self._o, node)
 
     def node_values (self, node):
-        u"""return (key, value) pairs attached to a node"""
+        """return (key, value) pairs attached to a node"""
         return libhivexmod.node_values (self._o, node)
 
     def node_get_value (self, node, key):
-        u"""return named key at node"""
+        """return named key at node"""
         return libhivexmod.node_get_value (self._o, node, key)
 
     def value_key_len (self, val):
-        u"""return the length of a value's key"""
+        """return the length of a value's key"""
         return libhivexmod.value_key_len (self._o, val)
 
     def value_key (self, val):
-        u"""return the key of a (key, value) pair"""
+        """return the key of a (key, value) pair"""
         return libhivexmod.value_key (self._o, val)
 
     def value_type (self, val):
-        u"""return data length and data type of a value"""
+        """return data length and data type of a value"""
         return libhivexmod.value_type (self._o, val)
 
     def node_struct_length (self, node):
-        u"""return the length of a node"""
+        """return the length of a node"""
         return libhivexmod.node_struct_length (self._o, node)
 
     def value_struct_length (self, val):
-        u"""return the length of a value data structure"""
+        """return the length of a value data structure"""
         return libhivexmod.value_struct_length (self._o, val)
 
     def value_value (self, val):
-        u"""return data length, data type and data of a value"""
+        """return data length, data type and data of a value"""
         return libhivexmod.value_value (self._o, val)
 
     def value_string (self, val):
-        u"""return value as a string"""
+        """return value as a string"""
         return libhivexmod.value_string (self._o, val)
 
     def value_multiple_strings (self, val):
-        u"""return value as multiple strings"""
+        """return value as multiple strings"""
         return libhivexmod.value_multiple_strings (self._o, val)
 
     def value_dword (self, val):
-        u"""return value as a DWORD"""
+        """return value as a DWORD"""
         return libhivexmod.value_dword (self._o, val)
 
     def value_qword (self, val):
-        u"""return value as a QWORD"""
+        """return value as a QWORD"""
         return libhivexmod.value_qword (self._o, val)
 
     def commit (self, filename):
-        u"""commit (write) changes to file"""
+        """commit (write) changes to file"""
         return libhivexmod.commit (self._o, filename)
 
     def node_add_child (self, parent, name):
-        u"""add child node"""
+        """add child node"""
         return libhivexmod.node_add_child (self._o, parent, name)
 
     def node_delete_child (self, node):
-        u"""delete child node"""
+        """delete child node"""
         return libhivexmod.node_delete_child (self._o, node)
 
     def node_set_values (self, node, values):
-        u"""set (key, value) pairs at a node"""
+        """set (key, value) pairs at a node"""
         return libhivexmod.node_set_values (self._o, node, values)
 
     def node_set_value (self, node, val):
-        u"""set a single (key, value) pair at a given node"""
+        """set a single (key, value) pair at a given node"""
         return libhivexmod.node_set_value (self._o, node, val)
 
diff --git a/regedit/Makefile.in b/regedit/Makefile.in
index 6830c80..6caaa5a 100644
--- a/regedit/Makefile.in
+++ b/regedit/Makefile.in
@@ -689,8 +689,8 @@ PTHREAD_H_DEFINES_STRUCT_TIMESPEC = @PTHREAD_H_DEFINES_STRUCT_TIMESPEC@
 PTRDIFF_T_SUFFIX = @PTRDIFF_T_SUFFIX@
 PYTHON = @PYTHON@
 PYTHON_INCLUDEDIR = @PYTHON_INCLUDEDIR@
+PYTHON_INSTALLDIR = @PYTHON_INSTALLDIR@
 PYTHON_PREFIX = @PYTHON_PREFIX@
-PYTHON_SITE_PACKAGES = @PYTHON_SITE_PACKAGES@
 PYTHON_VERSION = @PYTHON_VERSION@
 RAKE = @RAKE@
 RANLIB = @RANLIB@
diff --git a/ruby/Makefile.in b/ruby/Makefile.in
index 0145cf5..b19b067 100644
--- a/ruby/Makefile.in
+++ b/ruby/Makefile.in
@@ -663,8 +663,8 @@ PTHREAD_H_DEFINES_STRUCT_TIMESPEC = @PTHREAD_H_DEFINES_STRUCT_TIMESPEC@
 PTRDIFF_T_SUFFIX = @PTRDIFF_T_SUFFIX@
 PYTHON = @PYTHON@
 PYTHON_INCLUDEDIR = @PYTHON_INCLUDEDIR@
+PYTHON_INSTALLDIR = @PYTHON_INSTALLDIR@
 PYTHON_PREFIX = @PYTHON_PREFIX@
-PYTHON_SITE_PACKAGES = @PYTHON_SITE_PACKAGES@
 PYTHON_VERSION = @PYTHON_VERSION@
 RAKE = @RAKE@
 RANLIB = @RANLIB@
diff --git a/ruby/ext/hivex/_hivex.c b/ruby/ext/hivex/_hivex.c
index 96212c8..1d7fae0 100644
--- a/ruby/ext/hivex/_hivex.c
+++ b/ruby/ext/hivex/_hivex.c
@@ -650,8 +650,7 @@ ruby_hivex_value_type (VALUE hv, VALUE valv)
  *
  * return the length of a node
  *
- * Return the length of the node data structure. Returns 0
- * and sets errno on error.
+ * Return the length of the node data structure.
  *
  *
  * (For the C API documentation for this function, see
@@ -683,8 +682,7 @@ ruby_hivex_node_struct_length (VALUE hv, VALUE nodev)
  *
  * return the length of a value data structure
  *
- * Return the length of the value data structure. Returns 0
- * and sets errno on error.
+ * Return the length of the value data structure.
  *
  *
  * (For the C API documentation for this function, see
diff --git a/sh/Makefile.in b/sh/Makefile.in
index 0a64810..22bd8d2 100644
--- a/sh/Makefile.in
+++ b/sh/Makefile.in
@@ -726,8 +726,8 @@ PTHREAD_H_DEFINES_STRUCT_TIMESPEC = @PTHREAD_H_DEFINES_STRUCT_TIMESPEC@
 PTRDIFF_T_SUFFIX = @PTRDIFF_T_SUFFIX@
 PYTHON = @PYTHON@
 PYTHON_INCLUDEDIR = @PYTHON_INCLUDEDIR@
+PYTHON_INSTALLDIR = @PYTHON_INSTALLDIR@
 PYTHON_PREFIX = @PYTHON_PREFIX@
-PYTHON_SITE_PACKAGES = @PYTHON_SITE_PACKAGES@
 PYTHON_VERSION = @PYTHON_VERSION@
 RAKE = @RAKE@
 RANLIB = @RANLIB@
diff --git a/xml/Makefile.in b/xml/Makefile.in
index ba72879..1a611da 100644
--- a/xml/Makefile.in
+++ b/xml/Makefile.in
@@ -722,8 +722,8 @@ PTHREAD_H_DEFINES_STRUCT_TIMESPEC = @PTHREAD_H_DEFINES_STRUCT_TIMESPEC@
 PTRDIFF_T_SUFFIX = @PTRDIFF_T_SUFFIX@
 PYTHON = @PYTHON@
 PYTHON_INCLUDEDIR = @PYTHON_INCLUDEDIR@
+PYTHON_INSTALLDIR = @PYTHON_INSTALLDIR@
 PYTHON_PREFIX = @PYTHON_PREFIX@
-PYTHON_SITE_PACKAGES = @PYTHON_SITE_PACKAGES@
 PYTHON_VERSION = @PYTHON_VERSION@
 RAKE = @RAKE@
 RANLIB = @RANLIB@
-- 
